<!DOCTYPE html>
<html>
    <head>
        <title>POI-Suche in Bochum</title>
    
        <meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"  />
		<meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
		
		<script src="js/leaflet1.0.2.js"></script>
		<link rel="stylesheet" href="css/leaflet1.0.2.css" />
		
		<script src="js/deps.js"></script>
		<script src="js/leaflet-include.js"></script>


		<link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css" />


		
    </head>
	    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
			background: 'white';
        }

        #export {
            position: absolute;
            top:16%;
            right:94.5%;
            z-index:1000;
            background: grey;
            color:white;
            padding:6px;
            border-radius:4px;
			border-radius: 100%;
            font-family: 'Helvetica Neue';
            cursor: pointer;
            font-size:12px;
            text-decoration:none;
        }
		
	
    </style>
	
	
    <body>

    </div>
	
		<a href='#' id='export'>Export Features</a>
        <div id="map"></div>
		<button id="convert">
		Get all features to GeoJSON string
		</button>



		<script src="js/L.Control.Locate.js" ></script>
		<script src="js/easy-button.js"></script>
		<script src="data/rahmen1.js"></script>
		
		<link rel="stylesheet" href="css/L.Control.Locate.css" />
		<link rel="stylesheet" href="css/easy-button.css" />
				
	
        <script>
		
		//Einrichtung der Basiskarte
		var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
			osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
			osm = L.tileLayer(osmUrl, {maxZoom: 17,  opacity:1});
			
		var Standorte = new L.layerGroup();
		
			
		//Einrichtung der Karte
		var map = L.map('map', {zoomControl: false, rotate: true, touchRotate: false})
				.setView([51.44459561, 7.26093000], 17);
				//.addLayer(osm);
				//addLayer(Standorte);

		//Drehung der Karte um Winkel x		
		var angle = 27.825;
		map.setBearing(angle);	
		
		//Einrichtung der Campuskarte
		var CampusMapLinear = L.tileLayer('result2/{z}/{x}/{y}.png',{
		maxZoom: 18,
		minZoom: 16
		}).addTo(map);
		
		var overlayMaps = {
		"Standorte": Standorte
		};
		
		var styleRahmen = {
		"color": 'rgb(0, 0, 1)',
		"weight": 2.5,
		"opacity": 0,
		"fillOpacity": 0
		};
		
		//L.control.layers(null, overlayMaps).addTo(map);
		
		json_rahmenJSON = new L.geoJson(json_rahmen1, {interactive: false, style: styleRahmen}).addTo(map);
		
		//map.setMaxBounds(json_rahmenJSON.getBounds());
		
		//Standart MarkerIcon für Gebrauch mit Angle 
		var smallIcon2 = new L.Icon({
			iconUrl: 'css/images/marker-icon.png',
			iconRetinaUrl: 'css/images/marker-icon-2x.png',
			iconSize:    [25, 41],
			iconAnchor:  [12, 41],
			popupAnchor: [1, -34],
			shadowUrl: 'css/images/marker-shadow.png',
			shadowSize:  [41, 41]
		});


//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------				
	
	//Button für Standortsuche implementieren
	L.control.locate({
    strings: {
        title: "Standort anzeigen"
    },	
	locateOptions: {
               timeout: 10000}																				//ist auch der Default-Wert von Leaflet	   
	}).addTo(map);

	//Reset-Button einfügen
	L.easyButton('fa fa-thumb-tack', function(){
	map.addOneTimeEventListener('locationfound', function (event) {
	var marker = L.marker(event.latlng, {icon: smallIcon2}).addTo(Standorte).addTo(map).on('click', onClick);
	marker.properties = {};
	var feature = marker.feature = marker.feature || {};
	feature.type = "Feature";
	feature.properties = feature.properties || {};
	var content = document.createElement("textarea");
	
    content.addEventListener("keyup", function () {
    	//marker.properties.Name = content.value;   --> lediglich für den Marker --> wird nicht an layer übertragen
		feature.properties["Name"] = content.value;
    });
    marker.on("popupopen", function () {
    	//content.value = marker.properties.Name;	--> lediglich für den Marker --> wird nicht an layer übertragen
		feature.properties["Name"] = content.value;
      content.focus();
    });
    marker.bindPopup(content).openPopup();
	
	function onClick(e) {
   console.log(marker.properties);
   console.log(Standorte.properties);
   
	}
	//marker.properties.Name = "Test";
	//marker.addTo(Standorte);
	//});
	})
	}).addTo(map);
	
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------				
	        document.getElementById('export').onclick = function(e) {
            // Extract GeoJson from featureGroup
            var data = Standorte.toGeoJSON();

            // Stringify the GeoJson
            var convertedData = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data));
			

            // Create export
			document.getElementById('export').setAttribute('href', 'data:' + convertedData);
            document.getElementById('export').setAttribute('download','data.geojson');
			
			//Log-Methode
			//console.log(JSON.stringify(Standorte.toGeoJSON(), null, 2));
        }
	
    </script>

</body>
</html>